<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TriLingo</title>
    <style>
       
        @import url('https://fonts.googleapis.com/css2?family=Poetsen+One&display=swap');

        body {
            font-family: 'Arial', sans-serif;
            background-color: #FFF7F1;
            line-height: 1.5;
        }

        h1 {
            font-family: 'Poetsen One';
            font-size: 30pt;
            font-weight: 800;
            color: #D20062;
        }

        h2, h3 {
            font-family: 'Arial';
            font-size: 12pt;
            font-weight: 200;
            color: #E78895;
        }

        h3 {
            margin-bottom: 20px; /* Adjusted margin */
            margin-left: 40px;
            margin-right: 40px;
            line-height: 1.5;
        }

        .footer-section {
            background-color: #D20062;
            padding-top: 25px;
	    	padding-bottom: 25px;
	   		 padding-left: 10px;
            padding-left: 10px;
            color: #B1B1B1;
            font-size: 8pt;
            text-align: center;
        }

        button {
            font-family: 'Arial';
            background-color: #E78895;
            border: none;
            color: #FFF7F1;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            font-size: 18px;
            cursor: pointer;
            border-radius: 15px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        #uploadBox {
            padding: 20px;
            border-radius: 0;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            width: 70%;
            height: 250px;
            background-color: white;
            margin: 0 auto;
        }

        #cameraBox {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        #cameraBox video {
            width: 100%;
            height: 100%;
        }

        #result {
            color: #E78895;
            display: flex; 
            justify-content: space-between; 
            background-color: #FFF7F1;
        }

        .result-column {
            flex: 1;
            margin: 0;
            padding: 0;
            margin-bottom: 20px;
            margin-left: 20px;
            margin-right: 20px;
        }

        .result-heading {
            font-family: 'Poetsen One';
            font-size: 18px;
            font-weight: 100;
            margin: 0;
            padding: 0;
            color: #D20062;
            line-height: 1;
            margin-top: 40px;
        }

        .result-text {
            font-family: 'Poppins';
            font-size: 26px;
            color: black;
            font-weight: 600;
            line-height: 1.5;
            cursor: pointer; /* Add cursor pointer */
        }

        #recognizing {
            font-size: 18px;
            margin-bottom: 20px;
            color: #E78895;
        }

        .action-button-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>TriLingo</h1>
    <h3>Take a picture to find out what it is called in English, Malay, and Chinese!</h3>
    <div id="uploadBox">
        <div id="cameraBox"></div>
        <img id="uploadedImage" src="" style="display: none;">
    </div>
    <div class="action-button-container">
        <button id="onCameraButton">On Camera</button>
    </div>
    <br>
    <div id="result" class="result-columns"></div>
</div>

<div class="footer-section">
    <div style="font-family: 'Poetsen One'; font-size: 16pt; font-weight: 800; color: white;">TriLingo Tots</div>
    TriLingo is in the developmental phase.<br>Please share your thoughts with us at trilingotots@gmail.com.
</div>

<script>

var cameraActive = false;
    var videoStream;
    var videoElement;

    document.getElementById('actionButton').addEventListener('click', function() {
        if (cameraActive) {
            switchToCameraMode();
        } else {
            switchToCaptureMode();
        }
    });

    document.getElementById('captureButton').addEventListener('click', function() {
        takePhoto();
    });

    function switchToCaptureMode() {
        clearResults();

	
	document.getElementById('onCameraButton').addEventListener('click', function() {
            takePhotoFromCamera();
        });

        function takePhotoFromCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(function(stream) {
                    var videoElement = document.createElement('video');
                    videoElement.srcObject = stream;
                    videoElement.play();

                    document.body.appendChild(videoElement);

                    var canvas = document.createElement('canvas');
                    var context = canvas.getContext('2d');

                    var captureButton = document.createElement('button');
                    captureButton.textContent = 'Capture';
                    document.body.appendChild(captureButton);

                    captureButton.addEventListener('click', function() {
                        canvas.width = videoElement.videoWidth;
                        canvas.height = videoElement.videoHeight;
                        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
                        
                        var imgUrl = canvas.toDataURL('image/jpeg');

                        var capturedImage = document.getElementById('capturedImage');
                        capturedImage.src = imgUrl;
                        capturedImage.style.display = 'block';
                        
                        stream.getTracks().forEach(function(track) {
                            track.stop();
                        });
                        videoElement.pause();
                        videoElement.srcObject = null;
                        videoElement.remove();
                        captureButton.remove();
                    });
                })
                .catch(function(err) {
                    console.error('Error accessing camera:', err);
                });
        }

    function recognizeImage(imgUrl) {
        fetch('https://vision.googleapis.com/v1/images:annotate?key=AIzaSyClrPxLer-VRuWIwtp_9v0xwCViUve5HMc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                "requests": [
                    {
                        "image": {
                            "content": imgUrl.split(",")[1] // Extracting base64 data
                        },
                        "features": [
                            {
                                "type": "LABEL_DETECTION"
                            }
                        ]
                    }
                ]
            }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.responses && data.responses[0] && data.responses[0].labelAnnotations && data.responses[0].labelAnnotations.length > 0) {
                const labels = data.responses[0].labelAnnotations.map(annotation => annotation.description);
                const recognitionResult = {
                    English: labels[0], // Assuming the most prominent object is the first label
                    Malay: "", // Placeholder for Malay translation
                    Chinese: "" // Placeholder for Chinese translation
                };
                translateText(recognitionResult.English, 'en', 'ms').then(malayText => {
                    recognitionResult.Malay = malayText;
                    return translateText(recognitionResult.English, 'en', 'zh-CN');
                }).then(chineseText => {
                    recognitionResult.Chinese = chineseText;
                    return getPinyin(chineseText, 'zh-CN');
                }).then(pinyin => {
                    recognitionResult["Pinyin Tones"] = pinyin;
                    displayResult(recognitionResult);
                }).catch(error => {
                    console.error('Error translating text:', error);
                    // If translation fails, display English result only
                    displayResult(recognitionResult);
                });
            } else {
                const recognitionResult = {
                    English: "Try again",
                    Malay: "Cuba lagi",
                    Chinese: "再试一次"
                };
                displayResult(recognitionResult);
            }
        })
        .catch(error => {
            console.error('Error recognizing image:', error);
        });
    }

    function displayResult(recognitionResult) {
        clearResults();
        for (var language in recognitionResult) {
            var resultDiv = document.getElementById('result');
            var columnDiv = document.createElement('div');
            columnDiv.classList.add('result-column');

            var heading = document.createElement('h2');
            heading.classList.add('result-heading');
            heading.textContent = language + ":";

            var text = document.createElement('p');
            text.classList.add('result-text');
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.textContent = recognitionResult[language];
            text.appendChild(wordSpan);

            if (language === 'Chinese') {
                var pinyinSpan = document.createElement('span');
                pinyinSpan.classList.add('pinyin');
                pinyinSpan.textContent = recognitionResult["Pinyin Tones"];
                text.appendChild(document.createElement('br')); // Add line break
                text.appendChild(pinyinSpan);
                columnDiv.appendChild(heading);
                columnDiv.appendChild(text);
                resultDiv.appendChild(columnDiv);
            } else {
                columnDiv.appendChild(heading);
                columnDiv.appendChild(text);
                resultDiv.appendChild(columnDiv);
            }

            // Add event listener to read out the words
            text.addEventListener('click', function() {
                speakText(this.querySelector('.word').textContent, language === 'Malay' ? 'ms' : 'en-US');
                if (language === 'Chinese' && this.querySelector('.pinyin')) {
                    speakText(this.querySelector('.pinyin').textContent, 'zh-CN');
                }
            });
        }
    }

    function clearResults() {
        var resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
    }

    async function translateText(text, sourceLanguage, targetLanguage) {
        const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=AIzaSyClrPxLer-VRuWIwtp_9v0xwCViUve5HMc&q=${encodeURIComponent(text)}&source=${sourceLanguage}&target=${targetLanguage}&format=text&model=base`, {
            method: 'POST'
        });
        const data = await response.json();
        if (data && data.data && data.data.translations && data.data.translations.length > 0) {
            return data.data.translations[0].translatedText;
        } else {
            throw new Error('Translation failed');
        }
    }

    async function getPinyin(chineseWord, sourceLanguage) {
        const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=AIzaSyClrPxLer-VRuWIwtp_9v0xwCViUve5HMc&q=${encodeURIComponent(chineseWord)}&source=${sourceLanguage}&target=${sourceLanguage}&format=text&model=base`, {
            method: 'POST'
        });
        const data = await response.json();
        if (data && data.data && data.data.translations && data.data.translations.length > 0) {
            return data.data.translations[0].translatedText;
        } else {
            throw new Error('Pinyin retrieval failed');
        }
    }

    function speakText(text, languageCode) {
        // Google Text-to-Speech API endpoint
        var ttsEndpoint = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyDQUaEzdQy4i-5thYcP4OA5rzMfMYc5BMM';

        // Request body
        var requestBody = JSON.stringify({
            input: {
                text: text
            },
            voice: {
                languageCode: languageCode, // Language code for English (US), Malay, or Chinese
                ssmlGender: 'MALE' // You can adjust the gender as needed
            },
            audioConfig: {
                audioEncoding: 'MP3' // You can adjust the audio encoding type
            }
        });

        // Fetch request to Google TTS API
        fetch(ttsEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: requestBody
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.audioContent) {
                // Decode base64 audio content
                var audioData = atob(data.audioContent);
                // Convert audio data to binary format
                var arrayBuffer = new ArrayBuffer(audioData.length);
                var uint8Array = new Uint8Array(arrayBuffer);
                for (var i = 0; i < audioData.length; i++) {
                    uint8Array[i] = audioData.charCodeAt(i);
                }
                // Create blob object from binary data
                var blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });

                // Play the audio
                var audioElement = new Audio(URL.createObjectURL(blob));
                audioElement.play();
            } else {
                throw new Error('Audio content not found in response');
            }
        })
        .catch(error => {
            console.error('Error fetching audio:', error);
        });
    }
</script>

</body>
</html>

