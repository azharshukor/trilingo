<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trilingo</title>
    <link rel="stylesheet" href="style.css">
</head>
	
<body>
<div class="container">
    <h1>Trilingo</h1>
    <h3>Take a photo to learn what it is in English, Malay and Chinese!</h3>
    <div id="uploadBox">
        <div id="cameraBox"></div>
        <img id="capturedImage" src="" style="display: none;">
    </div>
    <div class="action-button-container">
        <input type="file" accept="image/*" capture="environment" id="fileInput" style="display: none;">
        <button id="onCameraButton">Take a photo</button>
    </div>
    <div id="result" class="result-columns"></div>
</div>

<div class="footer-section">
    <div style="font-family: 'Poetsen One'; font-size: 16pt; font-weight: 800; color: #D20062;">Trilingo</div>
    Trilingo is in the developmental phase.<br>Please share your thoughts with us at trilingotots@gmail.com.
</div>

<script>
    document.getElementById('onCameraButton').addEventListener('click', function() {
        document.getElementById('fileInput').click();
    });

    document.getElementById('fileInput').addEventListener('change', function(event) {
        var file = event.target.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var imgUrl = e.target.result;
                var capturedImage = document.getElementById('capturedImage');
                capturedImage.src = imgUrl;
            	capturedImage.style.display = 'block';
            
            // Call the recognizeImage function with the image URL
            recognizeImage(imgUrl);
        };
        reader.readAsDataURL(file);
    }
});

    function recognizeImage(imgUrl) {
        fetch('https://vision.googleapis.com/v1/images:annotate?key=AIzaSyClrPxLer-VRuWIwtp_9v0xwCViUve5HMc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                "requests": [
                    {
                        "image": {
                            "content": imgUrl.split(",")[1] // Extracting base64 data
                        },
                        "features": [
                            {
                                "type": "LABEL_DETECTION"
                            }
                        ]
                    }
                ]
            }),
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.responses && data.responses[0] && data.responses[0].labelAnnotations && data.responses[0].labelAnnotations.length > 0) {
    const labels = data.responses[0].labelAnnotations.map(annotation => annotation.description);
    
    // Function to prioritize labels based on simplicity and relevance
    const prioritizeLabels = (labels) => {
        // Define a map of labels and their priority levels (lower is higher priority)
       const labelPriorities = {
    'cat': 1,
    'dog': 2,
    'cow': 3,
    'bird': 4,
    'horse': 5,
    'fish': 6,
    'rabbit': 7,
    'frog': 8,
    'turtle': 9,
    'snake': 10,
    'lion': 11,
    'tiger': 12,
    'elephant': 13,
    'butterfly': 14,
    'ant': 15,
    'spider': 16,
    'ladybug': 17,
    'dragonfly': 18,
    'bee': 19,
    'cup': 20, 
    'spoon': 21, 
    'fork': 22, 
    'plate': 23, 
    'bowl': 24, 
    'chopsticks': 25,
    'book': 26,
    'computer': 27,
    'bag': 28,
    'pillow': 29,
    'towel': 30,
    'shirt': 31, 
    'pants': 32,
    'shorts': 33,
    'skirt': 34,
    'clothes': 35,
    'toilet': 36,
    'toothbrush': 37,
    'toothpaste': 38,
    'cloud': 39,
    'sun': 40,
    'playground': 41, 
    'star': 42,
    'sea': 43,
    'sand': 44,
    'tree': 45,
    'leaf': 46,
    'grass': 47,
    'hand': 48,
    'leg': 49,
    'eye': 50,
    'nose': 51,
    'mouth': 52,
    'teeth': 53,
    'ears': 54,
    'ball': 55,
    'teddy bear': 56,
    'television': 57,
    'mobile phone': 58,
    'bottle': 59,
    'shoe': 60,
    'sandals': 61,
    'car': 62, // Added comma here
    'bus': 63,
    'motorcycle': 64,
    'van': 65,
    'bicycle': 66,
    'traffic light': 67,
};

        // Sort labels based on their priority levels
        labels.sort((a, b) => {
            const priorityA = labelPriorities[a.toLowerCase()] || Infinity; // Default to Infinity if priority not defined
            const priorityB = labelPriorities[b.toLowerCase()] || Infinity; // Default to Infinity if priority not defined
            return priorityA - priorityB;
        });

        return labels;
    };

    const prioritizedLabels = prioritizeLabels(labels);

    const recognitionResult = {
        English: prioritizedLabels[0] || "Unidentified", // Use the first label after prioritization, defaulting to "Unidentified" if no labels found
        Malay: "", // Placeholder for Malay translation
        Chinese: "" // Placeholder for Chinese translation
    };
                translateText(recognitionResult.English, 'en', 'ms').then(malayText => {
                    recognitionResult.Malay = malayText;
                    return translateText(recognitionResult.English, 'en', 'zh-CN');
                }).then(chineseText => {
                    recognitionResult.Chinese = chineseText;
                    return getPinyin(chineseText, 'zh-CN');
                }).then(pinyin => {
                    recognitionResult["Pinyin Tones"] = pinyin;
                    displayResult(recognitionResult);
                }).catch(error => {
                    console.error('Error translating text:', error);
                    // If translation fails, display English result only
                    displayResult(recognitionResult);
                });
            } else {
                const recognitionResult = {
                    English: "Try again",
                    Malay: "Cuba lagi",
                    Chinese: "再试一次"
                };
                displayResult(recognitionResult);
            }
        })
        .catch(error => {
            console.error('Error recognizing image:', error);
        });
    }

    function displayResult(recognitionResult) {
        clearResults();
        for (var language in recognitionResult) {
            var resultDiv = document.getElementById('result');
            var columnDiv = document.createElement('div');
            columnDiv.classList.add('result-column');

            var heading = document.createElement('h2');
            heading.classList.add('result-heading');
            heading.textContent = language + ":";

            var text = document.createElement('p');
            text.classList.add('result-text');
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.textContent = recognitionResult[language];
            text.appendChild(wordSpan);

            if (language === 'Chinese') {
                var pinyinSpan = document.createElement('span');
                pinyinSpan.classList.add('pinyin');
                pinyinSpan.textContent = recognitionResult["Pinyin Tones"];
                text.appendChild(document.createElement('br')); // Add line break
                text.appendChild(pinyinSpan);
                columnDiv.appendChild(heading);
                columnDiv.appendChild(text);
                resultDiv.appendChild(columnDiv);
            } else {
                columnDiv.appendChild(heading);
                columnDiv.appendChild(text);
                resultDiv.appendChild(columnDiv);
            }

            // Add event listener to read out the words
            text.addEventListener('click', function() {
                speakText(this.querySelector('.word').textContent, language === 'Malay' ? 'ms' : 'en-US');
                if (language === 'Chinese' && this.querySelector('.pinyin')) {
                    speakText(this.querySelector('.pinyin').textContent, 'zh-CN');
                }
            });
        }
    }

    document.getElementById('fileInput').addEventListener('change', function(event) {
    // Display loading message
    displayLoadingMessage();

    var file = event.target.files[0];
    if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var imgUrl = e.target.result;
            var capturedImage = document.getElementById('capturedImage');
            capturedImage.src = imgUrl;
            capturedImage.style.display = 'block';

            // Call the recognizeImage function with the image URL
            recognizeImage(imgUrl);
        };
        reader.readAsDataURL(file);
    }
});

function displayLoadingMessage() {
    var resultDiv = document.getElementById('result');
    resultDiv.innerHTML = '<p>Loading...</p>';
}
	
    function clearResults() {
        var resultDiv = document.getElementById('result');
        resultDiv.innerHTML = '';
    }

    async function translateText(text, sourceLanguage, targetLanguage) {
        const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=AIzaSyClrPxLer-VRuWIwtp_9v0xwCViUve5HMc&q=${encodeURIComponent(text)}&source=${sourceLanguage}&target=${targetLanguage}&format=text&model=base`, {
            method: 'POST'
        });
        const data = await response.json();
        if (data && data.data && data.data.translations && data.data.translations.length > 0) {
            return data.data.translations[0].translatedText;
        } else {
            throw new Error('Translation failed');
        }
    }

    async function getPinyin(chineseWord, sourceLanguage) {
        const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=AIzaSyClrPxLer-VRuWIwtp_9v0xwCViUve5HMc&q=${encodeURIComponent(chineseWord)}&source=${sourceLanguage}&target=${sourceLanguage}&format=text&model=base`, {
            method: 'POST'
        });
        const data = await response.json();
        if (data && data.data && data.data.translations && data.data.translations.length > 0) {
            return data.data.translations[0].translatedText;
        } else {
            throw new Error('Pinyin retrieval failed');
        }
    }

    function speakText(text, languageCode) {
        // Google Text-to-Speech API endpoint
        var ttsEndpoint = 'https://texttospeech.googleapis.com/v1/text:synthesize?key=AIzaSyDQUaEzdQy4i-5thYcP4OA5rzMfMYc5BMM';

        // Request body
        var requestBody = JSON.stringify({
            input: {
                text: text
            },
            voice: {
                languageCode: languageCode, // Language code for English (US), Malay, or Chinese
                ssmlGender: 'MALE' // You can adjust the gender as needed
            },
            audioConfig: {
                audioEncoding: 'MP3' // You can adjust the audio encoding type
            }
        });

        // Fetch request to Google TTS API
        fetch(ttsEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: requestBody
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.audioContent) {
                // Decode base64 audio content
                var audioData = atob(data.audioContent);
                // Convert audio data to binary format
                var arrayBuffer = new ArrayBuffer(audioData.length);
                var uint8Array = new Uint8Array(arrayBuffer);
                for (var i = 0; i < audioData.length; i++) {
                    uint8Array[i] = audioData.charCodeAt(i);
                }
                // Create blob object from binary data
                var blob = new Blob([arrayBuffer], { type: 'audio/mpeg' });

                // Play the audio
                var audioElement = new Audio(URL.createObjectURL(blob));
                audioElement.play();
            } else {
                throw new Error('Audio content not found in response');
            }
        })
        .catch(error => {
            console.error('Error fetching audio:', error);
        });
    }

	
</script>

</body>
</html>

